## 3、深入理解WebSocket协议

### 3.1简介

WebSocket：全双工、双向通信。使用自定义协议，客户端和服务端之间发送非常少量数据。

http：请求-相应模式，半双工通信。字节级开销。

> AJAX 是 "Asynchronous JavaScript and XML"（异步 JavaScript 和 XML）的缩写。它不是一种新的编程语言，而是一种使用现有的标准和技术的新方法。AJAX 是一种在无需重新加载整个网页的情况下，能够更新部分网页的技术。
>
> 在 AJAX 中，JavaScript 通过异步方式与服务器进行数据交换，这意味着它可以在不影响页面的其余部分或用户交互的情况下，请求额外的数据。这使得网页在等待服务器响应时可以继续处理其他事情，而不会阻塞或延迟，从而极大地提高了用户体验。
>
> AJAX 的工作原理如下：
>
> 1. 用户执行某个动作，如点击一个按钮，这会触发 JavaScript 事件。
> 2. JavaScript 创建一个 XMLHttpRequest 对象，然后向服务器发送一个请求，这个请求可以是获取数据，也可以是发送数据。
> 3. 服务器处理这个请求，然后返回一个响应。
> 4. JavaScript 使用这个响应更新网页。
>
> 虽然 AJAX 的名字中包含 "XML"，但实际上它可以处理各种数据格式，包括纯文本、HTML、JSON，甚至是二进制数据。
>
> AJAX 技术大大改善了网页的响应性和灵活性，使得网页能够提供类似于桌面应用的交互体验。

### 3.2WebSocket复用了HTTP的握手通道

WebSocket复用了http的握手通道。ajax就是在这样的通道上完成数据传输的，只不过ajax交互是短连接，在一次 request->response 之后，“通道”连接就断开了。

### 3.3HTTP协议升级为WebSocket协议

**在这个握手的过程当中，客户端和服务端主要做了两件事情：**

- 1）建立了一条连接“握手通道”用于通信（这点和HTTP协议相同，不同的是HTTP协议完成数据交互后就释放了这条握手通道，这就是所谓的“短连接”，它的生命周期是一次数据交互的时间，通常是毫秒级别的）；
- 2）将HTTP协议升级到WebSocket协议，并复用HTTP协议的握手通道，从而建立一条持久连接。

注意：维持“长连接”需要消耗服务器资源。

### 3.4WebSocket的帧和数据分片传输

HTTP协议是基于TCP实现的，HTTP发送数据也是分包转发的，就是将大数据根据报文形式分割成一小块一小块发送到服务端，服务端接收到客户端发送的报文后，再将小块的数据拼接组装。WebSocket协议也是通过分片打包数据进行转发的，不过策略上和HTTP的分包不一样。

WebSocket通信中，客户端发送数据分片是有序的，这一点和HTTP不一样，HTTP将消息分包之后，是并发无序的发送给服务端的，包信息在数据中的位置则在HTTP报文中存储，而WebSocket仅仅需要一个FIN比特位就能保证将数据完整的发送到服务端。

### 3.5Websocket连接保持和心跳检测

WebSocket长连接浪费服务端资源。但是，举个例子：你几个月没有和一个QQ好友聊天了，突然有一天他发QQ消息告诉你他要结婚了，你还是能在第一时间收到。那是因为，客户端和服务端一直再采用心跳来检查连接。

>`go func()` 是 Go 语言中创建协程（goroutine）的一种方式。在 Go 语言中，协程是一种轻量级的线程，由 Go 运行时管理。
>
>协程在 Go 中是非常重要的一个特性，它使得并发编程变得非常简单。你可以轻易地启动成千上万的协程，而不需要担心线程切换的开销。这使得 Go 语言非常适合编写高并发的程序。

**线程**：

1. 线程是操作系统层面的并发执行实体，每个线程都有自己的栈和寄存器，线程切换需要涉及到**内核态和用户态的切换**，开销较大。
2. 线程之间的通信通常使用**共享内存**，这需要程序员小心处理同步和锁，以避免出现竞态条件。
3. 线程的生命周期由**操作系统**来管理。

**协程**：

1. 协程是程序级别的，也就是说它完全运行在**用户态**，协程切换不涉及内核态和用户态的切换，开销较小。
2. 协程可以使用共享内存进行通信，但更常见的是通过使用**通道（Channel）**进行通信。这种方式更安全，更容易避免竞态条件。
3. 协程的生命周期由**程序**来管理。